<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Tent Dashboard</title>
    <link rel="manifest" href="/manifest.json?v=15">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0f0d">
    <meta name="description" content="Monitor your grow tent devices - lights, humidifier, and energy consumption">
    <link rel="stylesheet" href="styles.css?v=1.4">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>

<body>
    <!-- PWA Install Modal -->
    <div id="installModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-icon">
                <img src="https://api.iconify.design/noto:potted-plant.svg" alt="App Icon">
            </div>
            <div class="modal-text">
                <h3>Install Smart Tent</h3>
                <p>Install this app on your home screen for quick access and offline support.</p>
            </div>
            <div class="modal-actions">
                <button id="btnDismiss" class="btn-secondary">Not Now</button>
                <button id="btnInstall" class="btn-primary">Install</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-content settings-modal">
            <h3>‚öôÔ∏è Notification Settings</h3>

            <!-- Notification Permission Status -->
            <div id="notificationStatus" class="notification-status">
                <span id="notificationStatusText">Notifications: Checking...</span>
                <button id="btnEnableNotifications" class="btn-primary">Enable Notifications</button>
            </div>

            <div class="settings-form">
                <label class="setting-item">
                    <input type="checkbox" id="notifyWater" checked>
                    <span>üíß Water tank empty alerts</span>
                </label>
                <label class="setting-item">
                    <input type="checkbox" id="notifySocket" checked>
                    <span>üí° Socket on/off alerts</span>
                </label>
                <label class="setting-item">
                    <input type="checkbox" id="notifyPower" checked>
                    <span>‚ö° High power alerts</span>
                </label>
                <label class="setting-item threshold">
                    <span>Power threshold:</span>
                    <input type="number" id="powerThreshold" value="200" min="0" max="5000" step="10">
                    <span>W</span>
                </label>
            </div>
            <div class="modal-actions">
                <button id="btnCloseSettings" class="btn-primary">Close</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üå±</span>
                    <h1>Smart Tent</h1>
                </div>
                <div class="header-right">
                    <button id="btnSettings" class="settings-indicator" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                            </path>
                        </svg>
                    </button>
                    <div class="status-indicator">
                        <span class="pulse"></span>
                        <span class="status-text">Live</span>
                    </div>
                </div>
            </div>
            <p class="last-update">Last updated: <span id="lastUpdate">--</span></p>
        </header>

        <main class="dashboard">
            <!-- Grow Lights Card (Wiz) -->
            <div class="card card-lights" id="wizCard">
                <div class="card-header">
                    <div class="card-icon">üí°</div>
                    <div class="card-title">
                        <h2>Grow Lights</h2>
                        <span class="device-type">Wiz Socket</span>
                    </div>
                    <div class="status-badge" id="wizStatus">
                        <span class="badge offline">Offline</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="metric-grid metric-single">
                        <div class="metric metric-large">
                            <span class="metric-label">Status</span>
                            <span class="metric-value" id="wizPower">--</span>
                        </div>
                    </div>
                </div>
                <div class="card-error" id="wizError" style="display: none;"></div>
            </div>

            <!-- Humidifier Card (Dreo) -->
            <div class="card card-humidity" id="dreoCard">
                <div class="card-header">
                    <div class="card-icon">üí®</div>
                    <div class="card-title">
                        <h2>Humidifier</h2>
                        <span class="device-type">Dreo Smart</span>
                    </div>
                    <div class="status-badge" id="dreoStatus">
                        <span class="badge offline">Offline</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="metric-grid">
                        <div class="metric">
                            <span class="metric-label">Status</span>
                            <span class="metric-value" id="dreoPower">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Humidity</span>
                            <span class="metric-value" id="dreoHumidity">--%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Target</span>
                            <span class="metric-value" id="dreoTarget">--%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Mode</span>
                            <span class="metric-value" id="dreoMode">--</span>
                        </div>

                        <div class="metric metric-interactive" id="dreoDayTile">
                            <span class="metric-label">Day On % üëÜ</span>
                            <span class="metric-value" id="dreoRuntimeDay">--%</span>
                        </div>
                        <div class="metric metric-interactive" id="dreoWeekTile">
                            <span class="metric-label">Week On % üëÜ</span>
                            <span class="metric-value" id="dreoRuntimeWeek">--%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">All Time %</span>
                            <span class="metric-value" id="dreoRuntimeAll">--%</span>
                        </div>

                    </div>
                </div>
                <div class="card-error" id="dreoError" style="display: none;"></div>
            </div>


            <!-- Energy Monitor Card (Tapo) -->
            <div class="card card-energy" id="tapoCard">
                <div class="card-header">
                    <div class="card-icon">‚ö°</div>
                    <div class="card-title">
                        <h2>Energy Monitor</h2>
                        <span class="device-type">Tapo P110</span>
                    </div>
                    <div class="status-badge" id="tapoStatus">
                        <span class="badge offline">Offline</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="metric-grid">
                        <div class="metric metric-large">
                            <span class="metric-label">Current Power</span>
                            <span class="metric-value power-value" id="tapoPower">-- W</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Today</span>
                            <span class="metric-value" id="tapoToday">-- kWh</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">This Month</span>
                            <span class="metric-value" id="tapoMonth">-- kWh</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Month Cost</span>
                            <span class="metric-value" id="tapoMonthCost">‚Ç¨ --</span>
                        </div>
                        <div class="metric metric-interactive" id="tapoTodayCostTile">
                            <span class="metric-label">Today Cost üëÜ</span>
                            <span class="metric-value" id="tapoTodayCost">‚Ç¨ --</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Year (12mo)</span>
                            <span class="metric-value" id="tapoYear">-- kWh</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Year Cost</span>
                            <span class="metric-value" id="tapoYearCost">‚Ç¨ --</span>
                        </div>
                    </div>
                </div>
                <div class="card-error" id="tapoError" style="display: none;"></div>
            </div>

            <!-- PWM Fan Control Card -->
            <div class="card card-fan" id="fanCard">
                <div class="card-header">
                    <div class="card-icon">üåÄ</div>
                    <div class="card-title">
                        <h2>Ventilation Fan</h2>
                        <span class="device-type">ESP32 PWM</span>
                    </div>
                    <div class="status-badge" id="fanStatus">
                        <span class="badge offline">Offline</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="metric-grid fan-metrics">
                        <div class="metric">
                            <span class="metric-label">Mode</span>
                            <span class="metric-value" id="fanMode">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Speed</span>
                            <span class="metric-value" id="fanSpeed">--%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Signal</span>
                            <span class="metric-value" id="fanSignal">--</span>
                        </div>
                    </div>
                    <div class="fan-controls">
                        <div class="day-night-controls">
                            <div class="dn-control">
                                <span class="dn-icon">‚òÄÔ∏è</span>
                                <span class="dn-label">Day</span>
                                <input type="number" id="fanDaySpeed" min="0" max="100" value="75" class="dn-input"
                                    disabled>
                                <span class="dn-unit">%</span>
                            </div>
                            <div class="dn-control">
                                <span class="dn-icon">üåô</span>
                                <span class="dn-label">Night</span>
                                <input type="number" id="fanNightSpeed" min="0" max="100" value="30" class="dn-input"
                                    disabled>
                                <span class="dn-unit">%</span>
                            </div>
                        </div>
                        <div class="fan-buttons">
                            <button id="btnFanApply" class="btn-fan btn-primary" disabled>Save</button>
                        </div>
                    </div>
                </div>
                <div class="card-error" id="fanError" style="display: none;"></div>
            </div>

            <!-- Fan PIN Modal -->
            <div id="fanPinModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <h3>üîê Enter PIN</h3>
                    <p>Enter your 4-digit code to control the fan.</p>
                    <input type="password" id="fanPinInput" maxlength="4" pattern="[0-9]*" inputmode="numeric"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="pin-input">
                    <div id="fanPinError" class="pin-error" style="display: none;">Invalid PIN</div>
                    <div class="modal-actions">
                        <button id="btnPinCancel" class="btn-secondary">Cancel</button>
                        <button id="btnPinSubmit" class="btn-primary">Confirm</button>
                    </div>
                </div>
            </div>

            <!-- Fan Schedule Modal -->
            <div id="fanScheduleModal" class="modal" style="display: none;">
                <div class="modal-content schedule-modal">
                    <h3>üìÖ Fan Schedule</h3>
                    <div id="scheduleList" class="schedule-list"></div>
                    <button id="btnAddSchedule" class="btn-secondary">+ Add Entry</button>
                    <div class="modal-actions">
                        <button id="btnScheduleCancel" class="btn-secondary">Cancel</button>
                        <button id="btnScheduleSave" class="btn-primary">Save</button>
                    </div>
                </div>
            </div>

            <!-- Energy History Modal -->
            <div id="energyHistoryModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <h3>‚ö° Last 7 Days Cost</h3>
                    <div id="energyHistoryList" class="history-list"></div>
                    <div class="modal-actions">
                        <button id="btnEnergyHistoryClose" class="btn-primary">Close</button>
                    </div>
                </div>
            </div>

            <!-- Humidifier History Modal -->
            <div id="humidifierHistoryModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <h3>üí® Last 7 Days Runtime</h3>
                    <div id="humidifierHistoryList" class="history-list"></div>
                    <div class="modal-actions">
                        <button id="btnHumidifierHistoryClose" class="btn-primary">Close</button>
                    </div>
                </div>
            </div>

            <!-- Camera Card (Full Width) -->
            <div class="card card-camera" id="cameraCard">
                <div class="card-header">
                    <div class="card-icon">üé•</div>
                    <div class="card-title">
                        <h2>Camera</h2>
                        <span class="device-type">Live Stream</span>
                    </div>
                    <div class="status-badge" id="cameraStatusBadge">
                        <span class="badge" id="cameraStatus">Ready</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="camera-container" id="cameraContainer">
                        <div class="camera-overlay">
                            <button class="btn-play">‚ñ∂ Watch Stream</button>
                        </div>
                        <div class="camera-loading" style="display: none;">
                            <div class="spinner"></div>
                        </div>
                        <img id="cameraFeed" src="" alt="Stream" style="display: none;">
                    </div>
                </div>
            </div>

        </main>

        <footer class="footer">
            <p><a href="https://github.com/AlexBelguim/smart-tent" target="_blank"
                    style="color: inherit; text-decoration: none; opacity: 0.7;">GitHub</a></p>
            <p class="version">v2.0</p>
        </footer>
    </div>

    <script src="app.js?v=2.0"></script>
</body>

</html>